name: Auto Run Levanter App

on:
  push:
    paths:
      - 'config.env'
    branches:
      - master
  workflow_dispatch:

jobs:
  run-app:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Enable Corepack (for Yarn)
        run: corepack enable
      
      - name: Debug Environment
        run: |
          echo "=== ENVIRONMENT DEBUG ==="
          echo "Node version: $(node --version)"
          echo "Yarn version: $(yarn --version)"
          echo "Working directory: $(pwd)"
          echo "Files in current directory:"
          ls -la
          echo "=== CONFIG CHECK ==="
          if [ -f "config.env" ]; then
            echo "✓ config.env found"
          else
            echo "✗ config.env missing"
          fi
      
      - name: Install dependencies
        run: |
          echo "=== INSTALLING DEPENDENCIES ==="
          yarn install --frozen-lockfile --verbose
          echo "=== DEPENDENCY CHECK ==="
          yarn list --depth=0
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          echo "FFmpeg version: $(ffmpeg -version | head -n1)"
      
      - name: Pre-run Checks
        run: |
          echo "=== PRE-RUN CHECKS ==="
          echo "Checking package.json scripts:"
          cat package.json | grep -A 10 '"scripts"'
          if [ -f "index.js" ]; then echo "✓ index.js found"; else echo "✗ index.js missing"; fi
      
      - name: Run Bot with Auto-Restart
        env:
          NODE_ENV: production
        run: |
          echo "=== STARTING LEVANTER BOT ==="
          echo "Timestamp: $(date)"
          
          # Run bot with timeout and auto-restart loop
          timeout 18000 bash -c '
            attempt=1
            while true; do
              echo "=== ATTEMPT #$attempt at $(date) ==="
              
              # Run with pm2-runtime (stays in foreground) or node directly
              if yarn docker 2>&1 | while IFS= read -r line; do
                echo "[$(date +"%H:%M:%S")] $line"
              done; then
                echo "Bot exited normally, restarting in 5 seconds..."
                sleep 5
              else
                exit_code=$?
                echo "Bot crashed with exit code: $exit_code, analyzing and restarting..."
                echo "=== ERROR ANALYSIS ==="
                echo "System resources:"
                free -h
                df -h
                echo "Waiting 10 seconds before restart..."
                sleep 10
              fi
              
              attempt=$((attempt + 1))
            done
          ' || echo "=== TIMEOUT REACHED AFTER 5 HOURS ==="
      
      - name: Post-Run Analysis
        if: always()
        run: |
          echo "=== POST-RUN ANALYSIS ==="
          echo "Final timestamp: $(date)"
          echo "Checking for log files:"
          find . -name "*.log" -type f 2>/dev/null || echo "No log files found"
          echo "=== SYSTEM STATE ==="
          free -h
          df -h
      
      - name: Re-Trigger Workflow
        if: always()
        run: |
          echo "=== AUTO-RESTART WORKFLOW ==="
          echo "Triggering next run at $(date)"
          sleep 30
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/levanter.yml/dispatches \
            -d '{"ref":"${{ github.ref_name }}"}'
          echo "✓ Workflow restart triggered successfully"
